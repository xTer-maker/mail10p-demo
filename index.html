<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Email tạm thời</title>
    <style>
        body { font-family: Arial; background: #f4f4f4; text-align: center; padding: 20px; }
        .email-box { background: white; padding: 10px; border-radius: 8px; display: inline-block; }
        .inbox { margin-top: 20px; text-align: left; display: inline-block; width: 80%; }
        .mail { background: white; padding: 10px; margin-top: 10px; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>📧 Email Tạm Thời</h1>
    <div class="email-box">
        <b>Email của bạn:</b> <span id="email">Đang tạo...</span>
    </div>
    <div class="inbox" id="inbox">
        <h3>📥 Hộp thư đến</h3>
        <div id="messages">Chưa có thư...</div>
    </div>

    <script>
        const API = "https://api.mail.tm";
        let token = "";
        let userId = "";

        async function createEmail() {
            let name = Math.random().toString(36).substring(2,10);
            let domainRes = await fetch(`${API}/domains`);
            let domainData = await domainRes.json();
            let domain = domainData["hydra:member"][0].domain;

            let email = `${name}@${domain}`;
            let password = Math.random().toString(36);

            await fetch(`${API}/accounts`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ address: email, password: password })
            });

            let loginRes = await fetch(`${API}/token`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ address: email, password: password })
            });
            let loginData = await loginRes.json();
            token = loginData.token;

            let meRes = await fetch(`${API}/me`, { headers: { Authorization: `Bearer ${token}` }});
            let meData = await meRes.json();
            userId = meData.id;

            document.getElementById("email").textContent = email;
            fetchInbox();
            setInterval(fetchInbox, 5000);
        }

        async function fetchInbox() {
            let msgRes = await fetch(`${API}/messages`, { headers: { Authorization: `Bearer ${token}` }});
            let msgData = await msgRes.json();
            let box = document.getElementById("messages");
            box.innerHTML = "";
            if (msgData["hydra:member"].length === 0) {
                box.innerHTML = "Chưa có thư...";
                return;
            }
            msgData["hydra:member"].forEach(mail => {
                let div = document.createElement("div");
                div.className = "mail";
                div.innerHTML = `<b>Từ:</b> ${mail.from.address}<br>
                                 <b>Chủ đề:</b> ${mail.subject}<br>
                                 <pre>${mail.intro}</pre>`;
                box.appendChild(div);
            });
        }

        createEmail();
    </script>
</body>
</html>
